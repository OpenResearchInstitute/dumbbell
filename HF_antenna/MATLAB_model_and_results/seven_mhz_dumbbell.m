% Create a dipoleMeander antenna
% Generated by MATLAB(R) 9.14 and Antenna Toolbox 5.4.
% Generated on: 13-May-2023 08:00:20
% 40m band - start with a half wave dipole.
% 20m of wire, divided into 3 sections.
%% radiation resistance and efficiency model

% from that 1950s paper
% sin(x) squared graph, over 256 foot aerial
aerial_length = 256;
x = 0:pi/18:pi;
y = sin(x).*sin(x);

% recreate the A, B, C, D points on the graph

%idx_x = linspace(pi/5,pi,4)
idx = [1, 5, 8, 12, 15, 19]
labels = {'A', 'B', 'C', 'D', 'E', 'F'};
x_offset = [0, -0.05, -0.075, 0.075, 0.05, 0]


%p = plot((x*aerial_length)/pi, y, "Color", "k", "LineWidth", 2)


figure
p = plot(x, y, "-o", "Color", "k", "LineWidth", 2)
for ind = 1:length(labels)
    disp(x(idx(ind)))
text((x(idx(ind))) + x_offset(ind), y(idx(ind)) + 0.05, labels(ind), "Color", "b","FontSize", 18, "HorizontalAlignment", "center")
end

% Let's do some animation?
ABx = x(1:5)
ABy = y(1:5)
CDx = x(8:12)
CDy = y(8:12)
centerx = x(1:10)
centery = y(1:10)

hold on
area(ABx, ABy,"FaceColor","c" )
area(CDx, CDy, "FaceColor","g")
hold off

figure
hold on
p = plot(x, y, "-o", "Color", "k", "LineWidth", 2)
for ind = 1:length(labels)
    disp(x(idx(ind)))
text((x(idx(ind))) + x_offset(ind), y(idx(ind)) + 0.05, labels(ind), "Color", "b","FontSize", 18, "HorizontalAlignment", "center")
end
area(centerx, centery, "FaceColor", "b")
hold off

%% N5ESE antenna calculations

% But there is a method by which the portion acting as an aerial can be
% made to act as the center portion. This method causes the current, after
% reflection at the insulator, to build up to maximum in the aerial by
% putting the required length of wire between the aerial proper and the
% insulator. This special length of wire must be wound non-inductively and
% spaced at least 1 inch and of a length equal to a quarter wavelength for
% the band in use, minus one half the length of the aerial top. 



% This "loading coil" can be wound around a cylinder or flattened out in in
% a tab or wing or two-dimensional area. 

% 12 foot 7 band "doublet" has 11.5 feet in each loading coil, and 5 feet
% of radiator on each side.

n5ese_length_ft = 11.5+11.5+5+5;



%% parameters
% 7.1 MHz half wavelength is 21.126760563380284 m
% 7.1 MHz half wavelength is 69.29577464788733

% 7.2 MHz half wavelength is 20.833333333333332 m
% 7.2 MHz half wavelength is 68.33333333333333 ft

% 3.75 MHz half wavelength is 131.2 ft
% 3.75 MHz half wavelength is 40 m

% 1.9 MHz half wavelength is 258.94736842105266 ft
% 1.9 MHz half wavelength is 78.94736842105263 m

% take the middle one third of the structure for the radiating element
frequency = 14.2e6  % in Hz
c = 299792458   % speed of light in m/s

wavelength = c/frequency 
radiatorLength = wavelength/6 % one third of a half wave dipole in meters

u = symunit;
radiatorLength_ft = unitConvert(radiatorLength*u.m, u.ft)
[len units] = separateUnits(radiatorLength_ft);
len = double(len) % one third of a half wave dipole in feet. 

% if the folded elements are executed with a one inch gap,
% then set 
% antennaObject.NotchLength = 0.0254 m (one inch)
% this is the top horizonal length of the folded element. 

% antennaObject.NotchWidth is the height of the folded elements.

% the second through N values of 
% antennaObject.ArmLength are the bottom horizontal length
% of the folded element. We want this to be one inch too. Use NotchLength
% for that too.

% so now we solve for something space efficient. 
% perhaps a square? Let's get to as close a square shape as we can.

% we know the lenghth of wire in the folded element sections.
% it's equal to radiatorLength. 

% we know NotchLength = ArmLength 2 ... N = 0.0254 m
% we know the height and width of our square folded element
% will be equal to each other. This is antennaObject.NotchWidth 
% We just need to come up with the right expression.
% This one is brute force, which is not a great tactic.
% we did this at the gym that day. Need to recreate it.


NotchLength = 0.0254;

%radiatorLength = numHumps*(2*NotchWidth + 2*NotchLength)

%NotchRun = numHumps*2*NotchLength

%NotchWidth = height of folded elements = NotchRun
%substitute in NotchRun for NotchLength 

%radiatorLength = numHumps*(2*(numHumps*2*NotchLength) + 2*NotchLength)
%radiatorLength = numHumps*(4*numHumps*NotchLength + 2*NotchLength)
%radiatorLength = 4*NotchLength*numHumps^2 + 2*NotchLength*numHumps
%quadratic equation
% 0 = 4*NotchLength*numHumps^2 + 2*NotchLength*numHumps - radiatorLength
A = 4*NotchLength;
B = 2*NotchLength;
C = -radiatorLength;

numHumps = ((-B)+((B^2-4*A*C))^0.5)/(2*A)
numHumps_2= ((-B)-((B^2-4*A*C))^0.5)/(2*A);

% NotchRun is the horizontal length of the folded element section
% NotchWidth is the vertical length of the folded element section


% 12 feet of cable with up 1 foot up 1 foot over 1 foot down 1 foot over as one hump, 
% so there are 3 humps each 4 feet long 

% pick the floor or ceiling of this to get an integer result, and then recalculate the
% NotchWidth. 

integerNumHumps = floor(numHumps)

%radiatorLength = numHumps*(2*NotchWidth + 2*NotchLength)
finalNotchWidth = (radiatorLength - 2*integerNumHumps*NotchLength)/(integerNumHumps*2)


%% Antenna Properties 

antennaObject = dipoleMeander;
antennaObject.Width = 0.002623;
%antennaObject.ArmLength = [7.3152, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254, 0.0254];
antennaObject.ArmLength = [radiatorLength, repmat(NotchLength, 1, integerNumHumps)]

antennaObject.NotchLength = 0.0254;
antennaObject.NotchWidth = finalNotchWidth;
% Show
figure
show(antennaObject) 

%% Antenna Analysis 
% Define plot frequency 
plotFrequency = frequency;
% Define frequency range 
freqRange = (0.8*frequency:0.1*frequency:1.2*frequency);
% Reference Impedance 
refImpedance = 50;
%% calcluations

% impedance
%figure;
%impedance(antennaObject, freqRange)

% Antenna is typically constructed using wires. Use the wireStack 
% function to convert the strip model to a wire model. You cannot 
% change the geometric properties of the antenna. However, you can 
% set the FeedLocation, FeedVoltage, Tilt, and TiltAxis properties. 
% To update the geometrical properties such as ArmLength and Width, 
% you must convert the wire model back to the strip model.

wireAntennaObject = wireStack(antennaObject)

% show the antenna
figure
show(wireAntennaObject)

% impedance of wire antenna
figure
impedance(wireAntennaObject, freqRange)

% produce antenna pattern
figure
pattern(wireAntennaObject, frequency)

% Antenna efficiency of microstrip antenna
figure
efficiency(antennaObject, freqRange)

% Charge distribution on antenna
figure
charge(wireAntennaObject, frequency)

% Current distribution on antenna
figure
current(wireAntennaObject, frequency)

%% Special Operations
%openExample('antenna/atx_farfield_visualization')

% Define Spatial Plane Extent
lambda = physconst('lightspeed')/frequency;
SpatialInfo.XSpan = 0.4*lambda; % was 5*lambda
SpatialInfo.YSpan = 0.4*lambda;
SpatialInfo.ZSpan = 0.4*lambda;
SpatialInfo.NumPointsX = 400;
SpatialInfo.NumPointsY = 400;
SpatialInfo.NumPointsZ = 400;
% Define Time Extent
Tperiod = 1/frequency;
T = 2*Tperiod; % was 2
TimeInfo.TotalTime = T;
TimeInfo.SamplingTime = [];
% Define E-Field Data details
DataInfo.Component = 'Ex';
DataInfo.PlotPlane = 'XZ';
DataInfo.DataLimits = [-2 6];
DataInfo.ScaleFactor = 1;
DataInfo.GifFileName = 'dumbbellEz.gif';
DataInfo.CloseFigure = true;
%% Animate
helperAnimateEHFields(antennaObject,frequency,SpatialInfo, TimeInfo, DataInfo)
writeAnimation("dumbbellEz.gif") %helper function saves it for us already?